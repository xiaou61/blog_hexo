---
title: Vue3å¦‚ä½•ä¼˜é›…çš„åŠ è½½å¤§é‡å›¾ç‰‡ğŸš€ğŸš€ğŸš€
date: 2023-10-01 11:28:14
tags: æ˜é‡‘
categories: æ˜é‡‘
ai: true
---



# Vue3å¦‚ä½•ä¼˜é›…çš„åŠ è½½å¤§é‡å›¾ç‰‡ğŸš€ğŸš€ğŸš€

æœ€è¿‘å¼€å‘äº†ä¸€ä¸ªåŠŸèƒ½ï¼Œé¡µé¢é¦–é¡µä¼šåŠ è½½å¤§é‡çš„å›¾ç‰‡ï¼Œåˆæ¬¡è¿›å…¥é¡µé¢æ—¶ï¼Œä¼šå¯¼è‡´é¡µé¢æ€§èƒ½ä¸‹é™ï¼Œ

äºæ˜¯ä¹ï¼Œæˆ‘æ”¹è¿›äº†è¿™ä¸ªåŠŸèƒ½ï¼Œå¯ä»¥è®©æ‰€æœ‰å›¾ç‰‡è‡ªåŠ¨æ‡’åŠ è½½ã€‚

### ğŸš€ åŸç†

è¿™ä¸ªåŠŸèƒ½ä¸»è¦çš„åº•å±‚é€»è¾‘æ˜¯æ˜¯ä½¿ç”¨`IntersectionObserver` `API`ï¼Œ`IntersectionObserver`ç”¨äºåœ¨æµè§ˆå™¨ä¸­è§‚å¯Ÿå…ƒç´ çš„å¯è§æ€§å’Œä½ç½®å˜åŒ–ã€‚å®ƒå¯ä»¥å¸®åŠ©å¼€å‘è€…å®ç°ä¸€äº›åŠ¨æ€è¡Œä¸ºï¼Œå¦‚å›¾ç‰‡çš„æ‡’åŠ è½½ã€æ— é™æ»šåŠ¨ç­‰ã€‚

ç®€å•çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š

```ts
tså¤åˆ¶ä»£ç // åˆ›å»ºIntersectionObserverå®ä¾‹
const observer = new IntersectionObserver((entries, observer) => {
  // éå†è§‚å¯Ÿçš„å…ƒç´ 
  entries.forEach(entry => {
    // å¦‚æœå…ƒç´ å¯è§
    if (entry.isIntersecting) {
      // åŠ è½½å›¾ç‰‡
      const img = entry.target;
      const src = img.getAttribute('data-src');
      img.setAttribute('src', src);
      // åœæ­¢è§‚å¯Ÿè¯¥å…ƒç´ 
      observer.unobserve(img);
    }
  });
});

// è·å–æ‰€æœ‰éœ€è¦æ‡’åŠ è½½çš„å›¾ç‰‡å…ƒç´ 
const lazyImages = document.querySelectorAll('.lazy-image');

// è§‚å¯Ÿæ¯ä¸ªå›¾ç‰‡å…ƒç´ 
lazyImages.forEach(image => {
  observer.observe(image);
});
```

### ğŸš€ å®è·µ

æ¥ä¸‹æ¥æˆ‘ä»¬å®ç°ä¸€ä¸ªé€šç”¨çš„ `hook`ï¼ŒåŸºæœ¬çš„åŠŸèƒ½å¦‚ä¸‹ï¼š

1. ç»™å›¾ç‰‡æä¾›é»˜è®¤çš„å ä½å›¾ç‰‡ `src`ï¼ŒåŒæ—¶æä¾›`data-src`å±æ€§
2. ä¼ å…¥å›¾ç‰‡å¯¹åº”çš„ `ref` å±æ€§ã€‚
3. å½“å›¾ç‰‡è¿›å…¥å¯è§†åŒºåŸŸæ—¶ï¼Œä½¿ç”¨`data-src`å±æ€§æ›¿æ¢ `src` å±æ€§

```ts
tså¤åˆ¶ä»£ç import { onMounted, Ref } from "vue";
const options = {
  // root: document.querySelector(".container"), // æ ¹å…ƒç´ ï¼Œé»˜è®¤ä¸ºè§†å£
  rootMargin: "0px", // æ ¹å…ƒç´ çš„è¾¹è·
  threshold: 0.5, // å¯è§æ€§æ¯”ä¾‹é˜ˆå€¼
  once: true,
};

function callback(
  entries: IntersectionObserverEntry[],
  observer: IntersectionObserver
) {
  entries.forEach((entry) => {
    // å¤„ç†æ¯ä¸ªç›®æ ‡å…ƒç´ çš„å¯è§æ€§å˜åŒ–
    if (entry.intersectionRatio <= 0) return;
    const img: Element = entry.target;
    const src = img.getAttribute("data-src");

    img.setAttribute("src", src ?? ""); // å°†çœŸå®çš„å›¾ç‰‡åœ°å€èµ‹ç»™ src å±æ€§

    observer.unobserve(img);
  });
}

export const useInView = (ref: Ref) => {
  const observer = new IntersectionObserver(callback, options);

  onMounted(() => {
    Object.keys(ref.value).forEach((e) => observer.observe(ref.value[e]));
  });
};
htmlå¤åˆ¶ä»£ç <script setup lang="ts">
import { ref } from "vue";
import { useInView } from "./hooks/useInView";

const imgRef = ref(null);
useInView(imgRef);
</script>

<template>
  <h4>å…¬ä¼—å·ï¼šèŒèŒå“’è‰å¤´å°†å†›</h4>
  <div
    v-for="(_, idx) in new Array(200).fill(11)"
  >
    <img
      ref="imgRef"
      src="https://via.placeholder.com/200"
      :data-src="`https://picsum.photos/200/${180 + idx}`"
      alt="b"
    />
  </div>
</template>
```

å®é™…æ•ˆæœå¦‚ä¸‹

![lazy.gif](https://xiaou-1305448902.cos.ap-nanjing.myqcloud.com/img/202310011130087.webp)

è™½ç„¶åŸºæœ¬çš„åŠŸèƒ½è¦æ±‚å·²ç»å®Œæˆäº†ï¼Œä½†æ˜¯ç°åœ¨è¿˜ä¸å¤Ÿä¼˜é›…ï¼ï¼ï¼

### ğŸš€ ä¼˜åŒ–

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¢åŠ ä¸ªè¿‡æ¸¡åŠ¨ç”»ã€‚æ¯æ¬¡å½“åŠ è½½å®Œå›¾ç‰‡ï¼Œå°±ä»å ä½å›¾è¿‡æ¸¡åˆ°æ­£å¸¸å›¾ç‰‡æ¨¡å¼ã€‚

```ts
tså¤åˆ¶ä»£ç img.onload = () => {
  img.setAttribute('class', 'fade-in')
}
csså¤åˆ¶ä»£ç @keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* åº”ç”¨æ·¡å…¥åŠ¨ç”»åˆ°å…ƒç´  */
.fade-in {
  animation: fadeIn 0.6s ease-in;
}
```

![lazy2.gif](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/247cb7bc6e0e463294f47ac909d03f8c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=340&h=1894&s=5345697&e=gif&f=54&b=252424)

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```ts
tså¤åˆ¶ä»£ç import { onMounted, Ref } from "vue";
const options = {
  // root: document.querySelector(".container"), // æ ¹å…ƒç´ ï¼Œé»˜è®¤ä¸ºè§†å£
  rootMargin: "0px", // æ ¹å…ƒç´ çš„è¾¹è·
  threshold: 0.5, // å¯è§æ€§æ¯”ä¾‹é˜ˆå€¼
  once: true,
};

function callback(
  entries: IntersectionObserverEntry[],
  observer: IntersectionObserver
) {
  entries.forEach((entry) => {
    if (entry.intersectionRatio <= 0) return;
    const img = entry.target as HTMLImageElement;
    const src = img.getAttribute("data-src");

    img.setAttribute("src", src ?? ""); // å°†çœŸå®çš„å›¾ç‰‡åœ°å€èµ‹ç»™ src å±æ€§

    img.onload = () => {
      img.setAttribute("class", "fade-in");
    };

    observer.unobserve(img);
  });
}

export const useInView = (ref: Ref) => {
  const observer = new IntersectionObserver(
    callback,
    options
  );

  onMounted(() => {
    Object.keys(ref.value)
      .forEach((e) => observer.observe(ref.value[e]));
  });
};
htmlå¤åˆ¶ä»£ç <script setup lang="ts">
import { ref } from "vue";
import { useInView } from "./hooks/useInView";

const imgRef = ref(null);

useInView(imgRef);

</script>

<template>
  <h4>å…¬ä¼—å·ï¼šèŒèŒå“’è‰å¤´å°†å†›</h4>
  <div
    v-for="(_, idx) in new Array(200).fill(11)"
    style="width: 200px height: 200px;"
  >
    <img
      ref="imgRef"
      style="height: 100%"
      src="https://via.placeholder.com/200"
      :data-src="`https://picsum.photos/200/${180 + idx}`"
      alt="b"
    />
  </div>
</template>

<style scoped>
/* å®šä¹‰æ·¡å…¥åŠ¨ç”» */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* åº”ç”¨æ·¡å…¥åŠ¨ç”»åˆ°å…ƒç´  */
.fade-in {
  animation: fadeIn 0.6s ease-in;
}
</style>
```

